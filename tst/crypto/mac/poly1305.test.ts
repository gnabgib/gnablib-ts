import { suite } from 'uvu';
import * as assert from 'uvu/assert';
import { hex } from '../../../src/codec';
import { Ascon128, ChaCha20, Poly1305 } from '../../../src/crypto';

const tsts = suite('Poly1305');

const tests:[string, string,string,string][]=[
    //https://datatracker.ietf.org/doc/html/rfc7539#section-2.5.2
    [
        'RFC7539 eg',
        '85D6BE7857556D337F4452FE42D506A80103808AFB0DB2FD4ABFF6AF4149F51B',
        '43727970746F6772617068696320466F72756D2052657365617263682047726F7570',
        'A8061DC1305136C6C22B8BAF0C0127A9'
    ],
     //https://datatracker.ietf.org/doc/html/rfc7539#appendix-A.3
     [
        'RFC7539 vector 1',
        '0000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000'
    ],
     [
        'RFC7539 vector 2',
        '0000000000000000000000000000000036E5F6B5C5E06070F0EFCA96227A863E',
        '416E79207375626D697373696F6E20746F20746865204945544620696E74656E6465642062792074686520436F6E7472696275746F7220666F72207075626C69636174696F6E20617320616C6C206F722070617274206F6620616E204945544620496E7465726E65742D4472616674206F722052464320616E6420616E792073746174656D656E74206D6164652077697468696E2074686520636F6E74657874206F6620616E204945544620616374697669747920697320636F6E7369646572656420616E20224945544620436F6E747269627574696F6E222E20537563682073746174656D656E747320696E636C756465206F72616C2073746174656D656E747320696E20494554462073657373696F6E732C2061732077656C6C206173207772697474656E20616E6420656C656374726F6E696320636F6D6D756E69636174696F6E73206D61646520617420616E792074696D65206F7220706C6163652C207768696368206172652061646472657373656420746F',
        '36E5F6B5C5E06070F0EFCA96227A863E'
    ],
     [
        'RFC7539 vector 3',
        '36E5F6B5C5E06070F0EFCA96227A863E00000000000000000000000000000000',
        '416E79207375626D697373696F6E20746F20746865204945544620696E74656E6465642062792074686520436F6E7472696275746F7220666F72207075626C69636174696F6E20617320616C6C206F722070617274206F6620616E204945544620496E7465726E65742D4472616674206F722052464320616E6420616E792073746174656D656E74206D6164652077697468696E2074686520636F6E74657874206F6620616E204945544620616374697669747920697320636F6E7369646572656420616E20224945544620436F6E747269627574696F6E222E20537563682073746174656D656E747320696E636C756465206F72616C2073746174656D656E747320696E20494554462073657373696F6E732C2061732077656C6C206173207772697474656E20616E6420656C656374726F6E696320636F6D6D756E69636174696F6E73206D61646520617420616E792074696D65206F7220706C6163652C207768696368206172652061646472657373656420746F',
        'F3477E7CD95417AF89A6B8794C310CF0'
    ],
     [
        'RFC7539 vector 4',
        '1C9240A5EB55D38AF333888604F6B5F0473917C1402B80099DCA5CBC207075C0',
        '2754776173206272696C6C69672C20616E642074686520736C6974687920746F7665730A446964206779726520616E642067696D626C6520696E2074686520776162653A0A416C6C206D696D737920776572652074686520626F726F676F7665732C0A416E6420746865206D6F6D65207261746873206F757467726162652E',
        '4541669A7EAAEE61E708DC7CBCC5EB62'
    ],
    [
        'RFC7539 vector 5',
        '0200000000000000000000000000000000000000000000000000000000000000',
        'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF',
        '03000000000000000000000000000000'
    ],
    [
        'RFC7539 vector 6',
        '02000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF',
        '02000000000000000000000000000000',
        '03000000000000000000000000000000'
    ],
    [
        'RFC7539 vector 7',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF11000000000000000000000000000000',
        '05000000000000000000000000000000'
    ],
    [
        'RFC7539 vector 8',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFEFEFEFEFEFEFEFEFEFEFEFEFEFEFE01010101010101010101010101010101',
        '00000000000000000000000000000000'
    ],
    [
        'RFC7539 vector 9',
        '0200000000000000000000000000000000000000000000000000000000000000',
        'FDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF'
    ],
    [
        'RFC7539 vector 10',
        '0100000000000000040000000000000000000000000000000000000000000000',
        'E33594D7505E43B900000000000000003394D7505E4379CD01000000000000000000000000000000000000000000000001000000000000000000000000000000',
        '14000000000000005500000000000000'
    ],    
    [
        'RFC7539 vector 11',
        '0100000000000000040000000000000000000000000000000000000000000000',
        'E33594D7505E43B900000000000000003394D7505E4379CD010000000000000000000000000000000000000000000000',
        '13000000000000000000000000000000'
    ],    
    //https://cs.opensource.google/go/x/crypto/+/master:internal/poly1305/vectors_test.go edge cases
    [
        'google vectors 1',
        '3B3A29E93B213A5C5C3B3B053A3A8C0D00000000000000000000000000000000',
        '81D8B2E46A25213B58FEE4213A2A28E921C12A9632516D3B73272727BECF2129',
        '6DC18B8C344CD79927118BBE84B7F314'
    ],
    [
        'google vectors 2',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'ffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000',
        '04000000000000000000000000000000' // (2¹³⁰-1) % (2¹³⁰-5)
    ],
    [
        'google vectors 3',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' // (2¹³⁰-6) % (2¹³⁰-5)
    ],
    [
        'google vectors 4',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000' // (2¹³⁰-5) % (2¹³⁰-5)
    ],
    [
        'google vectors 5',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        'F9FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' // (2*(2¹³⁰-6)) % (2¹³⁰-5)
    ],
    [
        'google vectors 6',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000' // (2*(2¹³⁰-5)) % (2¹³⁰-5)
    ],
    [
        'google vectors 7',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        'F8FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' // (3*(2¹³⁰-6)) % (2¹³⁰-5)
    ],
    [
        'google vectors 8',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000' // (3*(2¹³⁰-5)) % (2¹³⁰-5)
    ],
    [
        'google vectors 9',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        'F7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' // (4*(2¹³°-6)) % (2¹³°-5)
    ],
    [
        'google vectors 10',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000' // (4*(2¹³°-5)) % (2¹³°-5)
    ],
    [
        'google vectors 11',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        'F3FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' // (8*(2¹³°-6)) % (2¹³°-5)
    ],
    [
        'google vectors 12',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000' // (8*(2¹³°-5)) % (2¹³°-5)
    ],

    [
        'google vectors 13',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        'EBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' // (16*(2¹³°-6)) % (2¹³°-5)
    ],
    [
        'google vectors 14',
        '0100000000000000000000000000000000000000000000000000000000000000',
        'FBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
        '00000000000000000000000000000000' // (16*(2¹³°-5)) % (2¹³°-5)
    ],
    //https://cs.opensource.google/go/x/crypto/+/master:internal/poly1305/vectors_test.go original smoke tests
    [
        'google vectors 15',
        '746869732069732033322D62797465206B657920666F7220506F6C7931333035',
        '48656C6C6F20776F726C6421',
        'A6F745008F81C916A20DCC74EEF2B2F0' 
    ],
    [
        'google vectors 16',
        '746869732069732033322D62797465206B657920666F7220506F6C7931333035',
        '0000000000000000000000000000000000000000000000000000000000000000',
        '49EC78090E481EC6C26B33B91CCC0307' // (16*(2¹³°-5)) % (2¹³°-5)
    ],
];
for(const [descr,key,input,expect] of tests) {
    tsts(`mac{${descr}}`,()=>{
        const mac=new Poly1305(hex.toBytes(key));
        mac.write(hex.toBytes(input));
        const found=mac.sum();
        assert.is(hex.fromBytes(found),expect);
    });
}

tsts('reset',()=>{
    const mac=new Poly1305(hex.toBytes('3b3a29e93b213a5c5c3b3b053a3a8c0d00000000000000000000000000000000'));
    mac.write(Uint8Array.of(0));
    assert.is(hex.fromBytes(mac.sum()),'0F3B3A290938213A0C5C3B3B05383A8C','original sum');
    mac.reset();
    assert.is(hex.fromBytes(mac.sum()),'00000000000000000000000000000000','reset sum');
});

tsts('newEmpty',()=>{
    const mac=new Poly1305(hex.toBytes('3b3a29e93b213a5c5c3b3b053a3a8c0d00000000000000000000000000000000'));
    mac.write(Uint8Array.of(0));
    assert.is(hex.fromBytes(mac.sum()),'0F3B3A290938213A0C5C3B3B05383A8C','original sum');

    const other=mac.newEmpty();
    //Note it doesn't have any written data
    assert.is(hex.fromBytes(other.sum()),'00000000000000000000000000000000','clone sum');
});

const fromChaChaTests:[string, string,string,string,string][]=[
    [
        'RFC7539 Sec 2.6',
        '808182838485868788898A8B8C8D8E8F909192939495969798999A9B9C9D9E9F',
        '000000000001020304050607',
        '8AD5A08B905F81CC815040274AB29471A833B637E3FD0DA508DBB8E2FDD1A646',
        '923E3F4657B5AFB4A83FC9EBD7B0A048'
    ],
    [
        'RFC7539 A.4 #1',
        '0000000000000000000000000000000000000000000000000000000000000000',
        '000000000000000000000000',
        '76B8E0ADA0F13D90405D6AE55386BD28BDD219B8A08DED1AA836EFCC8B770DC7',
        '4EB972C9A8FB3A1B382BB4D36F5FFAD1'
    ],
    [
        'RFC7539 A.4 #2',
        '0000000000000000000000000000000000000000000000000000000000000001',
        '000000000000000000000002',
        'ECFA254F845F647473D3CB140DA9E87606CB33066C447B87BC2666DDE3FBB739',
        'AD442319D1BBF88C08EF64E332CF5A42'
    ],
    [
        'RFC7539 A.4 #3',
        '1C9240A5EB55D38AF333888604F6B5F0473917C1402B80099DCA5CBC207075C0',
        '000000000000000000000002',
        '965E3BC6F9EC7ED9560808F4D229F94B137FF275CA9B3FCBDD59DEAAD23310AE',
        '4CB5BC7D00441ED74664E8AF16A807BD'
    ],
];
for(const [descr,key,nonce,expectKey,expectPolyZero] of fromChaChaTests) {
    tsts(`fromCrypt{${descr}}`,()=>{
        const kBytes=hex.toBytes(key);
        const nBytes=hex.toBytes(nonce);
        const c=new ChaCha20(kBytes,nBytes);
        const mac=Poly1305.fromCrypt(c);
        assert.instance(mac,Poly1305);
        mac.write(new Uint8Array(mac.blockSize));
        assert.is(hex.fromBytes(mac.sum()),expectPolyZero,'polyZero (calc)');
    })
}

tsts(`fromCrypt-badSizeThrows`,()=>{
    const a=new Ascon128(new Uint8Array(16),new Uint8Array(16));
    assert.throws(()=>Poly1305.fromCrypt(a));
})

tsts.run();
